<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>3D Tilted US Map with Zoom & Highlight</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      perspective: 1500px;
      background: #f0f0f0;
    }
    svg {
      width: 100%;
      height: 100vh;
      display: block;
      transform: rotateX(35deg) rotateY(0deg);
      transform-origin: center center;
      filter: drop-shadow(5px 10px 5px rgba(0, 0, 0, 0.5));
    }
    .tooltip {
      position: absolute;
      background: white;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      pointer-events: none;
      font-size: 12px;
      display: none;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div class="tooltip" id="tooltip"></div>
  <svg id="map"></svg>

  <script>
    const width = window.innerWidth;
    const height = window.innerHeight;
    let zoomedState = null;

    const svg = d3.select("#map")
                  .attr("width", width)
                  .attr("height", height)
                  .call(d3.zoom().scaleExtent([1, 8]).on("zoom", zoomed));

    const g = svg.append("g");
    const tooltip = d3.select("#tooltip");

    const projection = d3.geoAlbersUsa()
                         .translate([width / 2, height / 2])
                         .scale(1000);

    const path = d3.geoPath().projection(projection);

    d3.json("ne_110m_admin_1_states_provinces.json")
      .then(data => {
        const states = g.selectAll("path")
          .data(data.features)
          .enter()
          .append("path")
          .attr("d", path)
          .attr("fill", "#cccccc")
          .attr("stroke", "#333")
          .attr("stroke-width", 1)
          .on("click", clicked)
          .on("mouseover", (event, d) => {
            tooltip.style("display", "block")
                   .text(d.properties.name)
                   .style("left", (event.pageX + 10) + "px")
                   .style("top", (event.pageY + 10) + "px");
          })
          .on("mousemove", (event) => {
            tooltip.style("left", (event.pageX + 10) + "px")
                   .style("top", (event.pageY + 10) + "px");
          })
          .on("mouseout", () => {
            tooltip.style("display", "none");
          });

        function clicked(event, d) {
          if (zoomedState === d) {
            reset();
          } else {
            const [[x0, y0], [x1, y1]] = path.bounds(d);
            event.stopPropagation();
            
            const zoomScale = Math.min(8, 0.9 / Math.max((x1 - x0) / width, (y1 - y0) / height));
            
            g.transition().duration(750).attr("transform",
              `translate(${width / 2}, ${height / 2}) scale(${zoomScale}) translate(${-((x0 + x1) / 2)}, ${-((y0 + y1) / 2)})`
            );

            tooltip.style("font-size", `${12 * zoomScale}px`)
                   .style("padding", `${5 * zoomScale}px`);
            
            states.attr("fill", "#cccccc"); // Reset all states
            d3.select(event.target).attr("fill", "#ffcc00"); // Highlight selected state

            zoomedState = d;
          }
        }

        svg.on("click", reset);
      })
      .catch(error => console.error("Error loading GeoJSON file:", error));

    function reset() {
      g.transition().duration(750).attr("transform", "translate(0,0) scale(1)");
      zoomedState = null;
      
      d3.selectAll("path").attr("fill", "#cccccc"); // Reset highlight
      tooltip.style("font-size", "12px")
             .style("padding", "5px");
    }

    function zoomed(event) {
      g.attr("transform", event.transform);
    }
  </script>
</body>
</html>
